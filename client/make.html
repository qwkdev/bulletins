<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Bulletins</title>

	<link rel="stylesheet" href="style.css">
</head>
<body>
	<div class="bg bgc1"></div>
	<div class="bg bgc2"></div>
	<div class="bg bgc3"></div>
	<div class="bg bgc4"></div>
	<div class="bg bgc5"></div>
	<div class="bg2 bgc1"></div>
	<div class="bg2 bgc2"></div>
	<div class="bg2 bgc3"></div>
	<div class="bg2 bgc4"></div>
	<div class="bg2 bgc5"></div>

	<div id="forms" style="--form: 2;">
		<div class="wrapper"><div class="form" id="front">
			<h1 class="header">Front Page</h1>
			<div class="value">
				<p>Top/Bottom Margins:</p>
				<div class="value-wrap">
					<input type="number" min="5" value="9" data-name="top-margin">
					<span>mm</span>
				</div>
			</div>
			<div class="value">
				<p>Left/Right Margins:</p>
				<div class="value-wrap">
					<input type="number" min="5" value="9" data-name="left-margin">
					<span>mm</span>
				</div>
			</div>
			<div class="text">
				<div class="inner-value">
					<p>Bulletin Title</p>
					<div class="value-wrap">
						<span>Size:</span>
						<input type="number" value="14" data-name="title-size">
					</div>
				</div>
				<textarea rows="2" data-name="title"><b>SUNDAY</b></textarea>
			</div>
			<div class="text">
				<div class="inner-value">
					<p>Church Title</p>
					<div class="value-wrap">
						<span>Size:</span>
						<input type="number" value="14" data-name="church-title-size">
					</div>
				</div>
				<textarea rows="3" data-name="church-title"><b>Father John Lyons & Deacon Nick Pryce
St Joseph's RC Church</b></textarea>
			</div>
			<div class="text">
				<div class="inner-value">
					<p>Church Info</p>
					<div class="value-wrap">
						<span>Size:</span>
						<input type="number" value="10" data-name="church-info-size">
					</div>
				</div>
				<textarea rows="4" data-name="church-info">3 Buchanan Street, Milngavie, G62 8DZ
Phone: 0141 956 1400
Email: stjoseph.milngavie@rcag.org.uk
Website: www.stjosephschurchmilngavie.co.uk</textarea>
			</div>
			<p class="header collapse-toggle" onclick="collapse('mass-info-collapse')">Mass times/info<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_iconCarrier"><path d="M6 9L12 15L18 9" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></g></svg></p>
			<div class="collapse" id="mass-info-collapse">
				<div class="value">
					<p>Text Size:</p>
					<div class="value-wrap">
						<input type="number" value="10" data-name="mass-info-size">
						<span>pt</span>
					</div>
				</div>
				<div class="multi" id="mass-info">
					<div class="template text">
						<div class="inner-value">
							<p></p>
							<div class="value-wrap">
								<button onclick="multimove(-1, this)">&#x2191;</button>
								<button onclick="multimove(1, this)">&#x2193;</button>
								<button onclick="multiremove(this)">X</button>
							</div>
						</div>
						<textarea rows="4" data-name="text"><b></b></textarea>
					</div>
				</div>
				<button class="multi-add" onclick="multiadd('mass-info')">+</button>
			</div>
			<p class="header collapse-toggle" onclick="collapse('latest-info-collapse')">Latest Info<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_iconCarrier"><path d="M6 9L12 15L18 9" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></g></svg></p>
			<div class="collapse" id="latest-info-collapse">
				<div class="value">
					<p>Text Size:</p>
					<div class="value-wrap">
						<input type="number" value="10" data-name="latest-info-size">
						<span>pt</span>
					</div>
				</div>
				<div class="multi" id="latest-info">
					<div class="template text">
						<div class="inner-value">
							<p></p>
							<div class="value-wrap">
								<span>Lines:</span>
								<input type="number" value="1" min="1" data-name="lines">
								
								<button onclick="multimove(-1, this)">&#x2191;</button>
								<button onclick="multimove(1, this)">&#x2193;</button>
								<button onclick="multiremove(this)">X</button>
							</div>
						</div>
						<textarea rows="2" data-name="text"><b></b></textarea>
					</div>
					<div class="text">
						<div class="inner-value">
							<p></p>
							<div class="value-wrap">
								<span>Lines:</span>
								<input type="number" value="1" min="1" data-name="lines">
								
								<button onclick="multimove(-1, this)">&#x2191;</button>
								<button onclick="multimove(1, this)">&#x2193;</button>
								<button onclick="multiremove(this)">X</button>
							</div>
						</div>
						<textarea rows="2" data-name="text"><i>For latest parish information please visit www.stjosephschurchmilngavie.co.uk</i></textarea>
					</div>
				</div>
				<button class="multi-add" onclick="multiadd('latest-info', true)">+</button>
			</div>
		</div></div>
		<div class="wrapper"><div class="form" id="info">
			<h1 class="header">Notices</h1>
			<div class="multi" id="notices">
				<div class="template text">
					<div class="inner-value">
						<p></p>
						<div class="value-wrap">
							<span>Margins:</span>
							<input type="number" value="0.8" data-name="margins">
							
							<span>Text Size:</span>
							<input type="number" value="10" data-name="size">
							
							<button onclick="multimove(-1, this)">&#x2191;</button>
							<button onclick="multimove(1, this)">&#x2193;</button>
							<button onclick="multiremove(this)">X</button>
						</div>
					</div>
					<textarea rows="4" data-name="text"><b></b></textarea>
				</div>
			</div>
			<button class="multi-add" onclick="multiadd('notices')">+</button>
		</div></div>
		<div class="wrapper"><div class="form" id="readings">
			<h1 class="header">Readings</h1>
			<p class="header collapse-toggle" onclick="collapse('readings-settings-collapse')">Settings<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_iconCarrier"><path d="M6 9L12 15L18 9" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></g></svg></p>
			<div class="collapse" id="readings-settings-collapse" hidden>
				<div class="value">
					<p>Top/Bottom Margins:</p>
					<div class="value-wrap">
						<input type="number" min="5" value="12" data-name="top-margin">
						<span>mm</span>
					</div>
				</div>
				<div class="value">
					<p>Left/Right Margins:</p>
					<div class="value-wrap">
						<input type="number" min="5" value="9" data-name="left-margin">
						<span>mm</span>
					</div>
				</div>
				<div class="value">
					<p>Headings Spacing:</p>
					<div class="value-wrap">
						<input type="number" value="5" data-name="heading-spacing">
						<span>mm</span>
					</div>
				</div>
				<div class="value">
					<p>Headings Text Size:</p>
					<div class="value-wrap">
						<input type="number" value="11" data-name="heading-size">
						<span>pt</span>
					</div>
				</div>
			</div>
			<p class="header collapse-toggle" onclick="collapse('copyright-collapse')">Copyright<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_iconCarrier"><path d="M6 9L12 15L18 9" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></g></svg></p>
			<div class="collapse" id="copyright-collapse" hidden>
				<div class="value">
					<p>Spacing:</p>
					<div class="value-wrap">
						<input type="number" value="20" data-name="copyright-spacing">
						<span>mm</span>
					</div>
				</div>
				<div class="value">
					<p>Text Size:</p>
					<div class="value-wrap">
						<input type="number" value="9" data-name="copyright-size">
						<span>pt</span>
					</div>
				</div>
				
				<div class="value">
					<p>Copyright</p>
					<div class="value-wrap">
						<span>Left</span>
						<label>
							<input type="checkbox" checked data-name="copyright-page">
							<span class="slider"></span>
						</label>
						<span>Right</span>
					</div>
				</div>
				<div class="value">
					<p>Data Protection Act</p>
					<div class="value-wrap">
						<span>Left</span>
						<label>
							<input type="checkbox" checked data-name="dpa-page">
							<span class="slider"></span>
						</label>
						<span>Right</span>
					</div>
				</div>
			</div>
			<p class="template header collapse-toggle" id="reading-collapse-toggle"><svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_iconCarrier"><path d="M6 9L12 15L18 9" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></g></svg></p>
			<div class="template collapse" id="reading-collapse" hidden>
				<div class="value">
					<p>Show/Hide reading:</p>
					<div class="value-wrap">
						<span>Hidden</span>
						<label>
							<input type="checkbox" checked>
							<span class="slider"></span>
						</label>
						<span>Included</span>
					</div>
				</div>
				<div class="value">
					<p>Select Page:</p>
					<div class="value-wrap">
						<span>Left</span>
						<label>
							<input type="checkbox">
							<span class="slider"></span>
						</label>
						<span>Right</span>
					</div>
				</div>
				<div class="text">
					<div class="inner-value">
						<p>Reference:</p>
						<div class="value-wrap">
							<span>Hidden</span>
							<label>
								<input type="checkbox" checked>
								<span class="slider"></span>
							</label>
							<span>Included</span>
						</div>
					</div>
					<textarea rows="1"><b></b></textarea>
				</div>
				<div class="text">
					<div class="inner-value">
						<p>Caption:</p>
						<div class="value-wrap">
							<span>Hidden</span>
							<label>
								<input type="checkbox" checked>
								<span class="slider"></span>
							</label>
							<span>Included</span>
						</div>
					</div>
					<textarea rows="1"><b></b></textarea>
				</div>
				<div class="template value">
					<p>"If Sung" warning:</p>
					<div class="value-wrap">
						<span>Next Line</span>
						<label>
							<input type="checkbox" checked>
							<span class="slider"></span>
						</label>
						<span>Same Line</span>
					</div>
				</div>
				<div class="template text">
					<div class="inner-value">
						<p>Response:</p>
					</div>
					<textarea rows="1"><b></b></textarea>
				</div>
				<div class="text">
					<div class="inner-value">
						<p>Text:</p>
						<div class="value-wrap">
							<span>Margin:</span>
							<input type="number" value="20">
							
							<span>Text Size:</span>
							<input type="number" value="10">
						</div>
					</div>
					<textarea rows="8"><b></b></textarea>
				</div>
			</div>
		</div></div>
	</div>
	<div id="buttons">
		<button id="prev" onclick="step(-1)"><</button>
		<button id="save" onclick="save()">SAVE</button>
		<button id="next" onclick="step(1)" hidden>></button>
	</div>

	<div id="embed"></div>

	<script>
		const forms = document.getElementById('forms');
		const prevBtn = document.getElementById('prev');
		const nextBtn = document.getElementById('next');
		function step(direction) {
			let cur = Number(forms.style.getPropertyValue("--form"));
			cur += direction;

			if (cur < 0) { cur = 2; }
			else if (cur > 2) { cur = 0; }
			forms.style.setProperty("--form", cur);

			prevBtn.hidden = cur == 0;
			nextBtn.hidden = cur == 2;
		}

		function collapse(collapseId) {
			console.log(collapseId);
			const col = document.getElementById(collapseId);
			console.log(col);
			console.log(col.hidden);
			col.hidden = !col.hidden;
			console.log(col.hidden);
		}

		function multiadd(multiId, reverse=false) {
			const multi = document.getElementById(multiId);

			const template = multi.querySelector('.template');
			const clone = template.cloneNode(true);
			clone.classList.remove('template');

			if (reverse) multi.insertBefore(clone, multi.children[1]);
			else multi.appendChild(clone);
		}
		function multiremove(btn) {
			btn.parentElement.parentElement.parentElement.remove();
		}
		function multimove(dir, btn) {
			console.log('multimove');
			const ele = btn.parentElement.parentElement.parentElement;

			if (dir == -1) {
				const prev = ele.previousElementSibling;
				if (prev) ele.parentNode.insertBefore(ele, prev);
			} else if (dir == 1) {
				const next = ele.nextElementSibling;
				if (next) ele.parentNode.insertBefore(next, ele);
			}
		}

		const readingTypes = {
			reading1: 'First Reading',
			psalm: 'Psalm',
			reading2: 'Second Reading',
			acclamation: 'Acclamation',
			gospel: 'Gospel'
		}

		const readings = document.getElementById('readings');
		const readingTemplateToggle = document.getElementById('reading-collapse-toggle');
		const readingTemplate = document.getElementById('reading-collapse');
		function loadReadings(data) {
			data.forEach((r, i) => {
				// console.log(r['type'], r['alt'], r['ref'], r['title']);

				const newReadingToggle = readingTemplateToggle.cloneNode(true);
				newReadingToggle.classList.remove('template');
				newReadingToggle.innerHTML = (readingTypes[r['type']] || 'Reading') + (r['alt'] ? ' (Alt)' : '') + newReadingToggle.innerHTML;
				newReadingToggle.onclick = function() { collapse(`reading-collapse-${i+1}`); };
				readings.appendChild(newReadingToggle);

				const newReading = readingTemplate.cloneNode(true);
				newReading.classList.remove('template');
				newReading.id = `reading-collapse-${i+1}`;

				if (r['type'] == 'psalm' || r['type'] == 'acclamation') {
					newReading.querySelector('.template.value').classList.remove('template');

					if (r['type'] == 'psalm') {
						newReading.querySelector('.template.text').classList.remove('template');
					}
				}

				readings.appendChild(newReading);
			});
		}

		function parseText(text) {
			return text.replace(/\n/g, "<br>");
		}

		function getValue(parent, name, func=null) {
			const ele = parent.querySelector(`input[data-name="${name}"], textarea[data-name="${name}"]`);
			if (ele.type === 'checkbox') return func === null ? ele.checked : func(ele.checked)
			return func === null ? ele.value : func(ele.value);
		}
		function getMulti(multiId, ...names) {
			const multi = document.getElementById(multiId);
			const items = multi.querySelectorAll(':scope > div:not(.template)');
			if (!items) return [];

			if (names.length === 1) return Array.from(items).map(ele => getValue(ele, names[0][0], names[0][1]));
			return Array.from(items).map(ele => names.map(p => getValue(ele, p[0], p[1])));
		}

		function save() {
			build();
		}

		function build() {
			const template = {
				front: {
					'top-margin': parseFloat,
					'left-margin': parseFloat,
					'title': parseText,
					'title-size': parseFloat,
					'church-title': parseText,
					'church-title-size': parseFloat,
					'church-info': parseText,
					'church-info-size': parseFloat,
					'mass-info-size': parseFloat,
					'latest-info-size': parseFloat
				},
				readings: {
					'top-margin': parseFloat,
					'left-margin': parseFloat,
					'heading-spacing': parseFloat,
					'heading-size': parseFloat,
					'copyright-spacing': parseFloat,
					'copyright-size': parseFloat,
					'copyright-page': c => c ? 1 : 0,
					'dpa-page': c => c ? 1 : 0
				}
			};

			const front = document.getElementById('front');
			const readingSection = document.getElementById('readings');
			const output = {
				front: Object.fromEntries(
					Object.entries(template.front).map(
						([name, func]) => [name, getValue(front, name, func)]
					)
				),
				back: getMulti('notices', ['size', parseFloat], ['margins', parseFloat], ['text', parseText]),
				readings: {
					options: Object.fromEntries(
						Object.entries(template.readings).map(
							([name, func]) => [name, getValue(readingSection, name, func)]
						)
					),
					readings: {

					}
				}
			}

			//! TODO: Ensure reading section styling is from user

			output.front['mass-info'] = getMulti('mass-info', ['text', parseText]);
			output.front['latest-info'] = getMulti('latest-info', ['lines', parseInt], ['text', parseText]);

			return output;
		}

		fetch('/readings2.json', { method: 'GET' })
			.then(resp => resp.json())
			.then(data => {
				if (data['success']) loadReadings(data['readings']);
				else console.error('Readings returned falsy success');
			})
			.catch(e => console.error('Error getting readings:', error));

		save();
	</script>
</body>
</html>