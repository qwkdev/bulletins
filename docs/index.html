<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Bulletins</title>

	<link rel="stylesheet" href="style.css">
</head>
<body>
	<div class="bg bgc1"></div>
	<div class="bg bgc2"></div>
	<div class="bg bgc3"></div>
	<div class="bg bgc4"></div>
	<div class="bg bgc5"></div>
	<div class="bg2 bgc1"></div>
	<div class="bg2 bgc2"></div>
	<div class="bg2 bgc3"></div>
	<div class="bg2 bgc4"></div>
	<div class="bg2 bgc5"></div>

	<div id="forms" style="--form: 0;">
		<div class="wrapper"><div class="form" id="front">
			<h1 class="header">Front Page</h1>
			<div class="value">
				<p>Top/Bottom Margins:</p>
				<div class="value-wrap">
					<input type="number" min="5" value="9" data-name="top-margin">
					<span>mm</span>
				</div>
			</div>
			<div class="value">
				<p>Left/Right Margins:</p>
				<div class="value-wrap">
					<input type="number" min="5" value="9" data-name="left-margin">
					<span>mm</span>
				</div>
			</div>
			<div class="text">
				<div class="inner-value">
					<p>Bulletin Title</p>
					<div class="value-wrap">
						<span>Size:</span>
						<input type="number" value="14" data-name="title-size">
					</div>
				</div>
				<textarea rows="2" data-name="title"><b>SUNDAY</b></textarea>
			</div>
			<div class="text">
				<div class="inner-value">
					<p>Church Title</p>
					<div class="value-wrap">
						<span>Size:</span>
						<input type="number" value="14" data-name="church-title-size">
					</div>
				</div>
				<textarea rows="3" data-name="church-title"><b>Father John Lyons & Deacon Nick Pryce
St Joseph's RC Church</b></textarea>
			</div>
			<div class="text">
				<div class="inner-value">
					<p>Church Info</p>
					<div class="value-wrap">
						<span>Size:</span>
						<input type="number" value="10" data-name="church-info-size">
					</div>
				</div>
				<textarea rows="4" data-name="church-info">3 Buchanan Street, Milngavie, G62 8DZ
Phone: 0141 956 1400
Email: stjoseph.milngavie@rcag.org.uk
Website: www.stjosephschurchmilngavie.co.uk</textarea>
			</div>
			<p class="header collapse-toggle" onclick="collapse('mass-info-collapse')">Mass times/info<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_iconCarrier"><path d="M6 9L12 15L18 9" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></g></svg></p>
			<div class="collapse" id="mass-info-collapse">
				<div class="value">
					<p>Text Size:</p>
					<div class="value-wrap">
						<input type="number" value="10" data-name="mass-info-size">
						<span>pt</span>
					</div>
				</div>
				<div class="multi" id="mass-info">
					<div class="template text">
						<div class="inner-value">
							<p></p>
							<div class="value-wrap">
								<button onclick="multimove(-1, this)">&#x2191;</button>
								<button onclick="multimove(1, this)">&#x2193;</button>
								<button onclick="multiremove(this)">X</button>
							</div>
						</div>
						<textarea rows="4" data-name="text"><b></b></textarea>
					</div>
				</div>
				<button class="multi-add" onclick="multiadd('mass-info')">+</button>
			</div>
			<p class="header collapse-toggle" onclick="collapse('latest-info-collapse')">Latest Info<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_iconCarrier"><path d="M6 9L12 15L18 9" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></g></svg></p>
			<div class="collapse" id="latest-info-collapse">
				<div class="value">
					<p>Text Size:</p>
					<div class="value-wrap">
						<input type="number" value="10" data-name="latest-info-size">
						<span>pt</span>
					</div>
				</div>
				<div class="multi" id="latest-info">
					<div class="template text">
						<div class="inner-value">
							<div class="value-wrap">
								<span>Align Left</span>
								<label>
									<input type="checkbox" data-name="centered">
									<span class="slider"></span>
								</label>
								<span>Centered</span>
							</div>
							<div class="value-wrap">
								<span>Lines:</span>
								<input type="number" value="1" min="1" data-name="lines">
								
								<button onclick="multimove(-1, this)">&#x2191;</button>
								<button onclick="multimove(1, this)">&#x2193;</button>
								<button onclick="multiremove(this)">X</button>
							</div>
						</div>
						<textarea rows="2" data-name="text"><b></b></textarea>
					</div>
					<div class="text">
						<div class="inner-value">
							<div class="value-wrap">
								<span>Align Left</span>
								<label>
									<input type="checkbox" checked data-name="centered">
									<span class="slider"></span>
								</label>
								<span>Centered</span>
							</div>
							<div class="value-wrap">
								<span>Lines:</span>
								<input type="number" value="1" min="1" data-name="lines">
								
								<button onclick="multimove(-1, this)">&#x2191;</button>
								<button onclick="multimove(1, this)">&#x2193;</button>
								<button onclick="multiremove(this)">X</button>
							</div>
						</div>
						<textarea rows="2" data-name="text"><i>For latest parish information please visit www.stjosephschurchmilngavie.co.uk</i></textarea>
					</div>
				</div>
				<button class="multi-add" onclick="multiadd('latest-info', true)">+</button>
			</div>
		</div></div>
		<div class="wrapper"><div class="form" id="info">
			<h1 class="header">Notices</h1>
			<div class="multi" id="notices">
				<div class="template text">
					<div class="inner-value">
						<p></p>
						<div class="value-wrap">
							<span>Margins:</span>
							<input type="number" value="0.8" data-name="margins">
							
							<span>Text Size:</span>
							<input type="number" value="10" data-name="size">
							
							<button onclick="multimove(-1, this)">&#x2191;</button>
							<button onclick="multimove(1, this)">&#x2193;</button>
							<button onclick="multiremove(this)">X</button>
						</div>
					</div>
					<textarea rows="4" data-name="text"><b></b></textarea>
				</div>
			</div>
			<button class="multi-add" onclick="multiadd('notices')">+</button>
		</div></div>
		<div class="wrapper"><div class="form" id="readings">
			<h1 class="header">Readings</h1>
			<p class="header collapse-toggle" onclick="collapse('readings-settings-collapse')">Settings<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_iconCarrier"><path d="M6 9L12 15L18 9" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></g></svg></p>
			<div class="collapse" id="readings-settings-collapse" hidden>
				<div class="value">
					<p>Top/Bottom Margins:</p>
					<div class="value-wrap">
						<input type="number" min="5" value="12" data-name="top-margin">
						<span>mm</span>
					</div>
				</div>
				<div class="value">
					<p>Left/Right Margins:</p>
					<div class="value-wrap">
						<input type="number" min="5" value="9" data-name="left-margin">
						<span>mm</span>
					</div>
				</div>
				<div class="value">
					<p>Headings Spacing:</p>
					<div class="value-wrap">
						<input type="number" value="5" data-name="heading-spacing">
						<span>mm</span>
					</div>
				</div>
				<div class="value">
					<p>Headings Text Size:</p>
					<div class="value-wrap">
						<input type="number" value="11" data-name="heading-size">
						<span>pt</span>
					</div>
				</div>
			</div>
			<p class="header collapse-toggle" onclick="collapse('copyright-collapse')">Copyright<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_iconCarrier"><path d="M6 9L12 15L18 9" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></g></svg></p>
			<div class="collapse" id="copyright-collapse" hidden>
				<div class="value">
					<p>Spacing:</p>
					<div class="value-wrap">
						<input type="number" value="20" data-name="copyright-spacing">
						<span>mm</span>
					</div>
				</div>
				<div class="value">
					<p>Text Size:</p>
					<div class="value-wrap">
						<input type="number" value="9" data-name="copyright-size">
						<span>pt</span>
					</div>
				</div>
				
				<div class="value">
					<p>Copyright</p>
					<div class="value-wrap">
						<span>Left</span>
						<label>
							<input type="checkbox" checked data-name="copyright-page">
							<span class="slider"></span>
						</label>
						<span>Right</span>
					</div>
				</div>
				<div class="value">
					<p>Data Protection Act</p>
					<div class="value-wrap">
						<span>Left</span>
						<label>
							<input type="checkbox" checked data-name="dpa-page">
							<span class="slider"></span>
						</label>
						<span>Right</span>
					</div>
				</div>
			</div>
			<p class="template header collapse-toggle" id="reading-collapse-toggle"><svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_iconCarrier"><path d="M6 9L12 15L18 9" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></g></svg></p>
			<div class="template collapse" id="reading-collapse" hidden>
				<div class="value" data-name="show-hide">
					<p>Show/Hide reading:</p>
					<div class="value-wrap">
						<span>Hidden</span>
						<label>
							<input type="checkbox" checked data-name="include">
							<span class="slider"></span>
						</label>
						<span>Included</span>
					</div>
				</div>
				<div class="value">
					<p>Select Page:</p>
					<div class="value-wrap">
						<span>Left</span>
						<label>
							<input type="checkbox" data-name="left">
							<span class="slider"></span>
						</label>
						<span>Right</span>
					</div>
				</div>
				<div class="text">
					<div class="inner-value">
						<p>Reference:</p>
						<div class="value-wrap">
							<span>Hidden</span>
							<label>
								<input type="checkbox" checked data-name="include-ref">
								<span class="slider"></span>
							</label>
							<span>Included</span>
						</div>
					</div>
					<textarea rows="1" data-name="ref"></textarea>
				</div>
				<div class="text">
					<div class="inner-value">
						<p>Caption:</p>
						<div class="value-wrap">
							<span>Hidden</span>
							<label>
								<input type="checkbox" checked data-name="include-title">
								<span class="slider"></span>
							</label>
							<span>Included</span>
						</div>
					</div>
					<textarea rows="1" data-name="title"></textarea>
				</div>
				<div class="template value">
					<p>"If Sung" warning:</p>
					<div class="value-wrap">
						<span>Next Line</span>
						<label>
							<input type="checkbox" checked data-name="sameline">
							<span class="slider"></span>
						</label>
						<span>Same Line</span>
					</div>
				</div>
				<div class="text" data-name="edit-response">
					<div class="inner-value">
						<p>Response:</p>
					</div>
					<textarea rows="1" data-name="response"></textarea>
				</div>
				<div class="text">
					<div class="inner-value">
						<p>Text:</p>
						<div class="value-wrap">
							<span>Margin:</span>
							<input type="number" value="20" data-name="margin">
							
							<span>Text Size:</span>
							<input type="number" value="10" data-name="size">
						</div>
					</div>
					<textarea rows="8" data-name="text"></textarea>
				</div>
			</div>
		</div></div>
	</div>
	<div id="buttons">
		<button id="prev" onclick="step(-1)" hidden><</button>
		<button id="save" onclick="save()">SAVE</button>
		<button id="next" onclick="step(1)">></button>
	</div>

	<div id="top">
		<h1>bulletins.mom</h1>
		<button onclick="modal('load-readings-modal')">Load Readings</button>
		<button onclick="modal('test-modal')">EXAMPLE</button>
		<button onclick="modal('save-template-modal')">Save Template</button>
		<button onclick="modal('load-template-modal')">Load Template</button>
	</div>

	<div id="embed"></div>

	<dialog id="load-readings-modal">
		<div class="modal">
			<h1 class="header">Load Readings</h1>
			<div class="value">
				<p>Enter date:</p>
				<div class="date-input">
					<span>D</span>
					<input type="number" min="1" max="31" data-name="day">
					<span>M</span>
					<input type="number" min="1" max="12" data-name="month">
					<span>Y</span>
					<input type="number" data-name="year">
				</div>
			</div>
			<div class="choice">
				<button onclick="">Load Blank Slate</button>
				<button class="action" onclick="wait(getReadings)">Get Readings</button>
			</div>
		</div>
	</div>

	<div id="wait" hidden>
		<h1>LOADING...</h1>
	</div>

	<script>
		const waitModal = document.getElementById('wait');
		async function wait(func, text='LOADING...') {
			waitModal.querySelector('h1').innerHTML = text;
			waitModal.hidden = false;
			await func();
			waitModal.hidden = true;
		}

		const forms = document.getElementById('forms');
		const prevBtn = document.getElementById('prev');
		const nextBtn = document.getElementById('next');
		function step(direction) {
			let cur = Number(forms.style.getPropertyValue("--form"));
			cur += direction;

			if (cur < 0) { cur = 2; }
			else if (cur > 2) { cur = 0; }
			forms.style.setProperty("--form", cur);

			prevBtn.hidden = cur == 0;
			nextBtn.hidden = cur == 2;
		}

		function collapse(collapseId) {
			const col = document.getElementById(collapseId);
			col.hidden = !col.hidden;
		}

		function multiadd(multiId, reverse=false) {
			const multi = document.getElementById(multiId);

			const template = multi.querySelector('.template');
			const clone = template.cloneNode(true);
			clone.classList.remove('template');

			if (reverse) multi.insertBefore(clone, multi.children[1]);
			else multi.appendChild(clone);
		}
		function multiremove(btn) {
			btn.parentElement.parentElement.parentElement.remove();
		}
		function multimove(dir, btn) {
			const ele = btn.parentElement.parentElement.parentElement;

			if (dir == -1) {
				const prev = ele.previousElementSibling;
				if (prev) ele.parentNode.insertBefore(ele, prev);
			} else if (dir == 1) {
				const next = ele.nextElementSibling;
				if (next) ele.parentNode.insertBefore(next, ele);
			}
		}

		const readingTypes = {
			reading1: 'First Reading',
			psalm: 'Psalm',
			reading2: 'Second Reading',
			acclamation: 'Acclamation',
			gospel: 'Gospel'
		}

		const readings = document.getElementById('readings');
		const readingTemplateToggle = document.getElementById('reading-collapse-toggle');
		const readingTemplate = document.getElementById('reading-collapse');
		function loadReadings(data) {
			const altAvailable = data
				.filter(r => r.alt)
				.map(r => r.type);

			data.forEach((r, i) => {
				// r['type'], r['alt'], r['ref'], r['title'];

				const newReadingToggle = readingTemplateToggle.cloneNode(true);
				newReadingToggle.classList.remove('template');
				newReadingToggle.innerHTML = (readingTypes[r.type] || 'Reading') + (r.alt ? ' (Alt)' : '') + newReadingToggle.innerHTML;
				newReadingToggle.onclick = function() { collapse(`reading-collapse-${i+1}`); };
				readings.appendChild(newReadingToggle);

				const newReading = readingTemplate.cloneNode(true);
				newReading.classList.remove('template');
				newReading.id = `reading-collapse-${i+1}`;

				newReading.dataset.name = 'reading-collapse';
				newReading.dataset.type = r.type;
				newReading.dataset.alt = r.alt ? 1 : 0;

				newReading.querySelector('textarea[data-name="ref"]').value = r.ref || '';
				newReading.querySelector('textarea[data-name="title"]').value = r.title || '';

				const editText = newReading.querySelector('textarea[data-name="text"]');
				if (r.type !== 'psalm') {
					newReading.querySelector('.text[data-name="edit-response"]').remove();
					editText.value = r.text.join('\n');
				} else {
					editText.value = r.text
						.slice(1)
						.map(p => p.join('\n'))
						.join('\n\n');

					newReading.querySelector('textarea[data-name="response"]').value = r.text[0] || '';
				}

				if (r.type === 'psalm' || r.type === 'acclamation') {
					newReading.querySelector('.template.value').classList.remove('template');
				}
				if (!altAvailable.includes(r.type)) {
					newReading.querySelector('.value[data-name="show-hide"]').remove();
				}

				readings.appendChild(newReading);
			});
		}

		function parseDate(value) {
			return value.padStart(2, '0').slice(0, 2);
		}
		function parseYear(value) {
			return ('20'+value).slice(-4);
		}
		async function getReadings() {
			const modal = document.getElementById('load-readings-modal');

			const day = getValue(modal, 'day', parseDate);
			const month = getValue(modal, 'month', parseDate);
			const year = getValue(modal, 'year', parseYear);
			console.log(`${year}${month}${day}`);

			await fetch('/readings2.json', { method: 'GET' })
				.then(resp => resp.json())
				.then(data => {
					if (data['success']) loadReadings(data['readings']);
					else console.error('Readings returned falsy success');
				})
				.catch(e => console.error('Error getting readings:', e));

			modal.close();
		}

		function parseText(text) {
			return text ? text.replace(/\n/g, "<br>") : '';
		}

		function getValue(parent, name, func=null) {
			const ele = parent.querySelector(`input[data-name="${name}"], textarea[data-name="${name}"]`);
			if (!ele) return func === null ? null : func(null);
			if (ele.type === 'checkbox') return func === null ? ele.checked : func(ele.checked);
			return func === null ? ele.value : func(ele.value);
		}
		function getMulti(multiId, ...names) {
			const multi = document.getElementById(multiId);
			const items = multi.querySelectorAll(':scope > div:not(.template)');
			if (!items) return [];

			if (names.length === 1) return Array.from(items).map(ele => getValue(ele, names[0][0], names[0][1]));
			return Array.from(items).map(ele => names.map(p => getValue(ele, p[0], p[1])));
		}

		function save() {
			build();
		}

		function build() {
			const template = {
				front: {
					'top-margin': parseFloat,
					'left-margin': parseFloat,
					'title': parseText,
					'title-size': parseFloat,
					'church-title': parseText,
					'church-title-size': parseFloat,
					'church-info': parseText,
					'church-info-size': parseFloat,
					'mass-info-size': parseFloat,
					'latest-info-size': parseFloat
				},
				readings: {
					'top-margin': parseFloat,
					'left-margin': parseFloat,
					'heading-spacing': parseFloat,
					'heading-size': parseFloat,
					'copyright-spacing': parseFloat,
					'copyright-size': parseFloat,
					'copyright-page': c => c ? 1 : 0,
					'dpa-page': c => c ? 1 : 0
				}
			};

			const front = document.getElementById('front');
			const readingSection = document.getElementById('readings');
			const output = {
				front: Object.fromEntries(
					Object.entries(template.front).map(
						([name, func]) => [name, getValue(front, name, func)]
					)
				),
				back: getMulti('notices', ['size', parseFloat], ['margins', parseFloat], ['text', parseText]),
				readings: {
					options: Object.fromEntries(
						Object.entries(template.readings).map(
							([name, func]) => [name, getValue(readingSection, name, func)]
						)
					),
					readings: []
				}
			}

			output.front['mass-info'] = getMulti('mass-info', ['text', parseText]);
			output.front['latest-info'] = getMulti('latest-info', ['centered', c => c ? 1 : 0], ['lines', parseInt], ['text', parseText]);

			const readingCollapses = readingSection.querySelectorAll('.collapse[data-name="reading-collapse"]');
			readingCollapses.forEach(ele => {
				if (getValue(ele, 'include') === false) return;
				const newReading = {
					left: !getValue(ele, 'left'),
					size: getValue(ele, 'size', parseFloat),
					margin: getValue(ele, 'margin', parseFloat),
					type: ele.dataset.type,
					alt: ele.dataset.alt == "1",
					ref: getValue(ele, 'include-ref') === false ? '' : getValue(ele, 'ref', parseText),
					title: getValue(ele, 'include-title') === false ? '' : getValue(ele, 'title', parseText),
					...(['psalm', 'acclamation'].includes(ele.dataset.type) && { sameline: getValue(ele, 'sameline') })
				};

				if (ele.dataset.type === 'psalm') {
					newReading.text = [
						getValue(ele, 'response', parseText),
						getValue(ele, 'text', parseText)
					]
				} else {
					newReading.text = getValue(ele, 'text', parseText);
				}

				output.readings.readings.push(newReading);
			});

			return output;
		}

		const modals = document.querySelectorAll('dialog');
		Array.from(modals).forEach(modal => {
			modal.addEventListener('click', e => {
				if (e.target === modal) {
					modal.close();
				}
			});
		});
		function modal(modalId) {
			document.getElementById(modalId).showModal();
		}

		// modal('load-readings-modal');
	</script>
</body>
</html>