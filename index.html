<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Bulletins</title>

	<link rel="stylesheet" href="style.css">
</head>
<body>
	<div id="mobile-wall">
		<p>
			Your screen is too small to use this app,<br>
			Please use a wider screen.
		</p>
		<h2>bulletins.mom</h2>
	</div>

	<div class="bg bgc1"></div>
	<div class="bg bgc2"></div>
	<div class="bg bgc3"></div>
	<div class="bg bgc4"></div>
	<div class="bg bgc5"></div>
	<div class="bg2 bgc1"></div>
	<div class="bg2 bgc2"></div>
	<div class="bg2 bgc3"></div>
	<div class="bg2 bgc4"></div>
	<div class="bg2 bgc5"></div>

	<div id="forms" style="--form: 0;">
		<div class="wrapper"><div class="form" id="front">
			<h1 class="header">Front Page</h1>
			<div class="value">
				<p>Top/Bottom Margins:</p>
				<div class="value-wrap">
					<input type="number" min="5" value="9" data-name="top-margin">
					<span>mm</span>
				</div>
			</div>
			<div class="value">
				<p>Left/Right Margins:</p>
				<div class="value-wrap">
					<input type="number" min="5" value="9" data-name="left-margin">
					<span>mm</span>
				</div>
			</div>
			<div class="text">
				<div class="inner-value">
					<p>Bulletin Title</p>
					<div class="value-wrap">
						<span>Size:</span>
						<input type="number" value="14" data-name="title-size">
					</div>
				</div>
				<textarea rows="2" data-name="title"><b>SUNDAY</b></textarea>
			</div>
			<div class="text">
				<div class="inner-value">
					<p>Church Title</p>
					<div class="value-wrap">
						<span>Size:</span>
						<input type="number" value="14" data-name="church-title-size">
					</div>
				</div>
				<textarea rows="3" data-name="church-title"><b>Father John Lyons & Deacon Nick Pryce
St Joseph's RC Church</b></textarea>
			</div>
			<div class="text">
				<div class="inner-value">
					<p>Church Info</p>
					<div class="value-wrap">
						<span>Size:</span>
						<input type="number" value="10" data-name="church-info-size">
					</div>
				</div>
				<textarea rows="4" data-name="church-info">3 Buchanan Street, Milngavie, G62 8DZ
Phone: 0141 956 1400
Email: stjoseph.milngavie@rcag.org.uk
Website: www.stjosephschurchmilngavie.co.uk</textarea>
			</div>
			<p class="header collapse-toggle" onclick="collapse('mass-info-collapse')">Mass times/info<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_iconCarrier"><path d="M6 9L12 15L18 9" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></g></svg></p>
			<div class="collapse" id="mass-info-collapse">
				<div class="value">
					<p>Text Size:</p>
					<div class="value-wrap">
						<input type="number" value="10" data-name="mass-info-size">
						<span>pt</span>
					</div>
				</div>
				<div class="multi" id="mass-info">
					<div class="template text">
						<div class="inner-value">
							<p></p>
							<div class="value-wrap">
								<button onclick="multimove(-1, this)">&#x2191;</button>
								<button onclick="multimove(1, this)">&#x2193;</button>
								<button onclick="multiremove(this)">X</button>
							</div>
						</div>
						<textarea rows="4" data-name="text"><b></b></textarea>
					</div>
				</div>
				<button class="multi-add" onclick="multiadd('mass-info')">+</button>
			</div>
			<p class="header collapse-toggle" onclick="collapse('latest-info-collapse')">Latest Info<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_iconCarrier"><path d="M6 9L12 15L18 9" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></g></svg></p>
			<div class="collapse" id="latest-info-collapse">
				<div class="value">
					<p>Text Size:</p>
					<div class="value-wrap">
						<input type="number" value="10" data-name="latest-info-size">
						<span>pt</span>
					</div>
				</div>
				<div class="multi" id="latest-info">
					<div class="template text">
						<div class="inner-value">
							<div class="value-wrap">
								<span>Align Left</span>
								<label>
									<input type="checkbox" data-name="centered">
									<span class="slider"></span>
								</label>
								<span>Centered</span>
							</div>
							<div class="value-wrap">
								<span>Lines:</span>
								<input type="number" value="1" min="1" data-name="lines">
								
								<button onclick="multimove(-1, this)">&#x2191;</button>
								<button onclick="multimove(1, this)">&#x2193;</button>
								<button onclick="multiremove(this)">X</button>
							</div>
						</div>
						<textarea rows="2" data-name="text"><b></b></textarea>
					</div>
					<div class="text">
						<div class="inner-value">
							<div class="value-wrap">
								<span>Align Left</span>
								<label>
									<input type="checkbox" checked data-name="centered">
									<span class="slider"></span>
								</label>
								<span>Centered</span>
							</div>
							<div class="value-wrap">
								<span>Lines:</span>
								<input type="number" value="1" min="1" data-name="lines">
								
								<button onclick="multimove(-1, this)">&#x2191;</button>
								<button onclick="multimove(1, this)">&#x2193;</button>
								<button onclick="multiremove(this)">X</button>
							</div>
						</div>
						<textarea rows="2" data-name="text"><i>For latest parish information please visit www.stjosephschurchmilngavie.co.uk</i></textarea>
					</div>
				</div>
				<button class="multi-add" onclick="multiadd('latest-info', true)">+</button>
			</div>
		</div></div>
		<div class="wrapper"><div class="form" id="info">
			<h1 class="header">Notices</h1>
			<div class="multi" id="notices">
				<div class="template text">
					<div class="inner-value">
						<p></p>
						<div class="value-wrap">
							<span>Margins:</span>
							<input type="number" value="0.8" data-name="margins">
							
							<span>Text Size:</span>
							<input type="number" value="10" data-name="size">
							
							<button onclick="multimove(-1, this)">&#x2191;</button>
							<button onclick="multimove(1, this)">&#x2193;</button>
							<button onclick="multiremove(this)">X</button>
						</div>
					</div>
					<textarea rows="4" data-name="text"><b></b></textarea>
				</div>
			</div>
			<button class="multi-add" onclick="multiadd('notices')">+</button>
		</div></div>
		<div class="wrapper"><div class="form" id="readings">
			<h1 class="header">Readings</h1>
			<p class="header collapse-toggle" onclick="collapse('readings-settings-collapse')">Settings<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_iconCarrier"><path d="M6 9L12 15L18 9" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></g></svg></p>
			<div class="collapse" id="readings-settings-collapse" hidden>
				<div class="value">
					<p>Top/Bottom Margins:</p>
					<div class="value-wrap">
						<input type="number" min="5" value="12" data-name="top-margin">
						<span>mm</span>
					</div>
				</div>
				<div class="value">
					<p>Left/Right Margins:</p>
					<div class="value-wrap">
						<input type="number" min="5" value="9" data-name="left-margin">
						<span>mm</span>
					</div>
				</div>
				<div class="value">
					<p>Headings Spacing:</p>
					<div class="value-wrap">
						<input type="number" value="5" data-name="heading-spacing">
						<span>mm</span>
					</div>
				</div>
				<div class="value">
					<p>Headings Text Size:</p>
					<div class="value-wrap">
						<input type="number" value="11" data-name="heading-size">
						<span>pt</span>
					</div>
				</div>
			</div>
			<p class="header collapse-toggle" onclick="collapse('copyright-collapse')">Copyright<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_iconCarrier"><path d="M6 9L12 15L18 9" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></g></svg></p>
			<div class="collapse" id="copyright-collapse" hidden>
				<div class="value">
					<p>Spacing:</p>
					<div class="value-wrap">
						<input type="number" value="20" data-name="copyright-spacing">
						<span>mm</span>
					</div>
				</div>
				<div class="value">
					<p>Text Size:</p>
					<div class="value-wrap">
						<input type="number" value="9" data-name="copyright-size">
						<span>pt</span>
					</div>
				</div>
				
				<div class="value">
					<p>Copyright</p>
					<div class="value-wrap">
						<span>Left</span>
						<label>
							<input type="checkbox" checked data-name="copyright-page">
							<span class="slider"></span>
						</label>
						<span>Right</span>
					</div>
				</div>
				<div class="value">
					<p>Data Protection Act</p>
					<div class="value-wrap">
						<span>Left</span>
						<label>
							<input type="checkbox" checked data-name="dpa-page">
							<span class="slider"></span>
						</label>
						<span>Right</span>
					</div>
				</div>
			</div>
			<p class="template header collapse-toggle" id="reading-collapse-toggle"><svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_iconCarrier"><path d="M6 9L12 15L18 9" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></g></svg></p>
			<div class="template collapse" id="reading-collapse" hidden>
				<div class="value" data-name="show-hide">
					<p>Show/Hide reading:</p>
					<div class="value-wrap">
						<span>Hidden</span>
						<label>
							<input type="checkbox" checked data-name="include">
							<span class="slider"></span>
						</label>
						<span>Included</span>
					</div>
				</div>
				<div class="value">
					<p>Select Page:</p>
					<div class="value-wrap">
						<span>Left</span>
						<label>
							<input type="checkbox" data-name="left">
							<span class="slider"></span>
						</label>
						<span>Right</span>
					</div>
				</div>
				<div class="text">
					<div class="inner-value">
						<p>Reference:</p>
						<div class="value-wrap">
							<span>Hidden</span>
							<label>
								<input type="checkbox" checked data-name="include-ref">
								<span class="slider"></span>
							</label>
							<span>Included</span>
						</div>
					</div>
					<textarea rows="1" data-name="ref"></textarea>
				</div>
				<div class="text">
					<div class="inner-value">
						<p>Caption:</p>
						<div class="value-wrap">
							<span>Hidden</span>
							<label>
								<input type="checkbox" checked data-name="include-title">
								<span class="slider"></span>
							</label>
							<span>Included</span>
						</div>
					</div>
					<textarea rows="1" data-name="title"></textarea>
				</div>
				<div class="template value">
					<p>"If Sung" warning:</p>
					<div class="value-wrap">
						<span>Next Line</span>
						<label>
							<input type="checkbox" checked data-name="sameline">
							<span class="slider"></span>
						</label>
						<span>Same Line</span>
					</div>
				</div>
				<div class="text" data-name="edit-response">
					<div class="inner-value">
						<p>Response:</p>
					</div>
					<textarea rows="1" data-name="response"></textarea>
				</div>
				<div class="text">
					<div class="inner-value">
						<p>Text:</p>
						<div class="value-wrap">
							<span>Margin:</span>
							<input type="number" value="20" data-name="margin">
							
							<span>Text Size:</span>
							<input type="number" value="10" data-name="size">
						</div>
					</div>
					<textarea rows="8" data-name="text"></textarea>
				</div>
			</div>
			<div id="readings-wrapper"></div>
		</div></div>
	</div>
	<div id="buttons">
		<button id="prev" onclick="step(-1)" hidden><</button>
		<button id="save" onclick="save()">SAVE</button>
		<button id="next" onclick="step(1)">></button>
	</div>

	<div id="top">
		<h1>bulletins.mom</h1>
		<button onclick="modal('load-readings-modal')">Load Readings</button>
		<button onclick="loadLast()">Edit Last</button>
		<button onclick="modal('save-template-modal')">Save Template</button>
		<button onclick="loadTemplatesModal()">Load Template</button>
	</div>

	<iframe id="embed" src=""></iframe>

	<dialog id="load-readings-modal">
		<div class="modal">
			<h1 class="header">Load Readings</h1>
			<div class="value">
				<p>Enter date:</p>
				<div class="date-input">
					<span>D</span>
					<input type="number" min="1" max="31" data-name="day">
					<span>M</span>
					<input type="number" min="1" max="12" data-name="month">
					<span>Y</span>
					<input type="number" data-name="year">
				</div>
			</div>
			<div class="choice">
				<button onclick="blankReadings()">Load Blank Slate</button>
				<button class="action" onclick="wait(getReadings)">Get Readings</button>
			</div>
		</div>
	</dialog>

	<dialog id="load-template-modal">
		<div class="modal">
			<h1 class="header">Load Template</h1>
			<div class="template value">
				<p data-name="name"></p>
				<div class="value-wrap">
					<button class="action" data-name="load">Load</button>
					<button data-name="delete">X</button>
				</div>
			</div>
			<div class="grid">
			</div>
		</div>
	</dialog>

	<dialog id="save-template-modal">
		<div class="modal">
			<h1 class="header">Save Template</h1>
			<div class="value">
				<p>Enter name:</p>
				<div class="value-wrap" style="width: 50%;">
					<input style="width: 100%;" type="text" data-name="name" oninput="safeFilename(this)">
				</div>
			</div>
			<div class="choice">
				<button class="action" onclick="saveTemplate()">Save</button>
			</div>
		</div>
	</dialog>

	<div id="wait" hidden>
		<h1>LOADING...</h1>
	</div>

	<script>
		const SERVER_URL = 'https://bulletins.pythonanywhere.com';
		const SCRAPE_SERVER_URL = 'https://universalis.vercel.app/api';

		async function checkAPIKey(key) {
			const resp = await fetch(`${SERVER_URL}/check?key=${key}`, { method: 'GET' })
				.then(resp => resp.json())
				.catch(e => console.error('Error checking API key:', e));

			return resp && resp['valid'];
		}
		async function getAPIKey() {
			let current = localStorage.getItem('bulletins-api-key');
			if (current && await checkAPIKey(current)) {
				return current;
			}
			localStorage.removeItem('bulletins-api-key');

			while (1) {
				const newKey = prompt('Enter API Key:');
				if (newKey && await checkAPIKey(newKey)) {
					localStorage.setItem('bulletins-api-key', newKey);
					return newKey;
				} else {
					alert('Invalid API Key, please try again.');
				}
			}
		}

		let API_KEY;
		(async () => { API_KEY = await getAPIKey(); })();

		const waitModal = document.getElementById('wait');
		async function wait(func, text='LOADING...') {
			waitModal.querySelector('h1').innerHTML = text;
			waitModal.hidden = false;
			await func();
			waitModal.hidden = true;
		}

		const forms = document.getElementById('forms');
		const prevBtn = document.getElementById('prev');
		const nextBtn = document.getElementById('next');
		function step(direction) {
			let cur = Number(forms.style.getPropertyValue("--form"));
			cur += direction;

			if (cur < 0) { cur = 2; }
			else if (cur > 2) { cur = 0; }
			forms.style.setProperty("--form", cur);

			prevBtn.hidden = cur == 0;
			nextBtn.hidden = cur == 2;
		}
		function setForm(num) {
			forms.style.setProperty("--form", num);
			prevBtn.hidden = num == 0;
			nextBtn.hidden = num == 2;
		}

		function collapse(collapseId) {
			const col = document.getElementById(collapseId);
			col.hidden = !col.hidden;
		}

		function multiadd(multiId, reverse=false) {
			const multi = document.getElementById(multiId);

			const template = multi.querySelector('.template');
			const clone = template.cloneNode(true);
			clone.classList.remove('template');

			if (reverse) multi.insertBefore(clone, multi.children[1]);
			else multi.appendChild(clone);

			return clone;
		}
		function multiremove(btn) {
			btn.parentElement.parentElement.parentElement.remove();
		}
		function multimove(dir, btn) {
			const ele = btn.parentElement.parentElement.parentElement;

			if (dir == -1) {
				const prev = ele.previousElementSibling;
				if (prev) ele.parentNode.insertBefore(ele, prev);
			} else if (dir == 1) {
				const next = ele.nextElementSibling;
				if (next) ele.parentNode.insertBefore(next, ele);
			}
		}

		const readingTypes = {
			reading1: 'First Reading',
			psalm: 'Psalm',
			reading2: 'Second Reading',
			acclamation: 'Acclamation',
			gospel: 'Gospel'
		}

		const readings = document.getElementById('readings');
		const readingsWrapper = document.getElementById('readings-wrapper');
		const readingTemplateToggle = document.getElementById('reading-collapse-toggle');
		const readingTemplate = document.getElementById('reading-collapse');
		function loadReadings(data) {
			const altAvailable = data
				.filter(r => r.alt)
				.map(r => r.type);

			readingsWrapper.innerHTML = '';
			data.forEach((r, i) => {
				// r['type'], r['alt'], r['ref'], r['title'];

				const newReadingToggle = readingTemplateToggle.cloneNode(true);
				newReadingToggle.classList.remove('template');
				newReadingToggle.innerHTML = (readingTypes[r.type] || 'Reading') + (r.alt ? ' (Alt)' : '') + newReadingToggle.innerHTML;
				newReadingToggle.onclick = function() { collapse(`reading-collapse-${i+1}`); };
				readingsWrapper.appendChild(newReadingToggle);

				const newReading = readingTemplate.cloneNode(true);
				newReading.classList.remove('template');
				newReading.id = `reading-collapse-${i+1}`;

				newReading.dataset.name = 'reading-collapse';
				newReading.dataset.type = r.type;
				newReading.dataset.alt = r.alt ? 1 : 0;

				if (['acclamation', 'gospel'].includes(r.type)) {
					newReading.querySelector('input[data-name="left"]').checked = true;
					if (r.sameline !== undefined) newReading.querySelector('input[data-name="sameline"]').checked = r.sameline;
				}

				newReading.querySelector('textarea[data-name="ref"]').value = r.ref || '';
				newReading.querySelector('textarea[data-name="title"]').value = r.title || '';

				if (r.include !== undefined) newReading.querySelector('input[data-name="include"]').checked = r.include;
				if (r.left !== undefined) newReading.querySelector('input[data-name="left"]').checked = !r.left;
				if (r.size !== undefined) newReading.querySelector('input[data-name="size"]').value = r.size;
				if (r.margin !== undefined) newReading.querySelector('input[data-name="margin"]').value = r.margin;

				const editText = newReading.querySelector('textarea[data-name="text"]');
				if (r.type !== 'psalm') {
					newReading.querySelector('.text[data-name="edit-response"]').remove();
					editText.value = r.text.join('\n');
				} else {
					editText.value = r.text
						.slice(1)
						.map(p => p.join('\n'))
						.join('\n\n');

					newReading.querySelector('textarea[data-name="response"]').value = r.text[0] || '';
				}

				if (r.type === 'psalm' || r.type === 'acclamation') {
					newReading.querySelector('.template.value').classList.remove('template');
				}
				if (!altAvailable.includes(r.type)) {
					newReading.querySelector('.value[data-name="show-hide"]').remove();
				}

				readingsWrapper.appendChild(newReading);
			});
		}

		function parseDate(value) {
			return value.padStart(2, '0').slice(0, 2);
		}
		function parseYear(value) {
			return ('20'+value).slice(-4);
		}
		async function getReadings() {
			const modal = document.getElementById('load-readings-modal');

			const day = getValue(modal, 'day', parseDate);
			const month = getValue(modal, 'month', parseDate);
			const year = getValue(modal, 'year', parseYear);

			modal.close();
			await fetch(`${SCRAPE_SERVER_URL}/?date=${year}${month}${day}&key=${API_KEY}`, { method: 'GET' })
				.then(resp => resp.json())
				.then(data => {
					if (data['success']) loadReadings(data['readings']);
					else console.error('Readings returned falsy success');
				})
				.catch(e => console.error('Error getting readings:', e));

			setForm(2);
			save();
		}

		function blankReadings() {
			document.getElementById('load-readings-modal').close();
			loadReadings([
				{ type: 'reading1',    alt: false, ref: null, title: null, text: [null]},
				{ type: 'psalm',       alt: false, ref: null, title: null, text: [null]},
				{ type: 'reading2',    alt: false, ref: null, title: null, text: [null]},
				{ type: 'acclamation', alt: false, ref: null, title: null, text: [null]},
				{ type: 'gospel',      alt: false, ref: null, title: null, text: [null]}
			]);
			setForm(2);
		}

		function parseText(text) {
			return text ? text.replace(/\n/g, "<br>") : '';
		}

		function getValue(parent, name, func=null) {
			const ele = parent.querySelector(`input[data-name="${name}"], textarea[data-name="${name}"]`);
			if (!ele) return func === null ? null : func(null);
			if (ele.type === 'checkbox') return func === null ? ele.checked : func(ele.checked);
			return func === null ? ele.value : func(ele.value);
		}
		function getMulti(multiId, ...names) {
			const multi = document.getElementById(multiId);
			const items = multi.querySelectorAll(':scope > div:not(.template)');
			if (!items) return [];

			if (names.length === 1) return Array.from(items).map(ele => getValue(ele, names[0][0], names[0][1]));
			return Array.from(items).map(ele => names.map(p => getValue(ele, p[0], p[1])));
		}
		function setValue(parent, name, value) {
			const ele = parent.querySelector(`input[data-name="${name}"], textarea[data-name="${name}"]`);
			if (!ele) return;
			if (ele.type === 'checkbox') { 
				ele.checked = value; 
				return;
			}
			ele.value = value;
		}
		function setMulti(multiId, list, ...names) {
			const multi = document.getElementById(multiId);
			multi.querySelectorAll(':scope > div:not(.template)').forEach(ele => ele.remove());
			if (names.length === 1) {
				list.forEach(item => {
					const newValue = multiadd(multiId);
					setValue(newValue, names[0], item);
				});
			} else {
				list.forEach(item => {
					const newValue = multiadd(multiId);
					names.forEach((name, i) => setValue(newValue, name, item[i]));
				});
			}
		}

		const iframe = document.getElementById('embed');
		async function save() {
			const resp = build();

			await wait(async function() {
				console.log(resp);
				await fetch(`${SERVER_URL}/build?key=${API_KEY}`, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					},
					body: JSON.stringify(resp)
				});
			});

			iframe.src = `https://view.officeapps.live.com/op/embed.aspx?src=${SERVER_URL}/get/${Date.now()}.docx?key=${API_KEY}`;
		}

		const buildTemplate = {
			front: {
				'top-margin': parseFloat,
				'left-margin': parseFloat,
				'title': parseText,
				'title-size': parseFloat,
				'church-title': parseText,
				'church-title-size': parseFloat,
				'church-info': parseText,
				'church-info-size': parseFloat,
				'mass-info-size': parseFloat,
				'latest-info-size': parseFloat
			},
			readings: {
				'top-margin': parseFloat,
				'left-margin': parseFloat,
				'heading-spacing': parseFloat,
				'heading-size': parseFloat,
				'copyright-spacing': parseFloat,
				'copyright-size': parseFloat,
				'copyright-page': c => c ? 1 : 0,
				'dpa-page': c => c ? 1 : 0
			}
		};
		function build() {
			const front = document.getElementById('front');
			const readingSection = document.getElementById('readings');
			const output = {
				front: Object.fromEntries(
					Object.entries(buildTemplate.front).map(
						([name, func]) => [name, getValue(front, name, func)]
					)
				),
				back: getMulti('notices', ['size', parseFloat], ['margins', parseFloat], ['text', parseText]),
				readings: {
					options: Object.fromEntries(
						Object.entries(buildTemplate.readings).map(
							([name, func]) => [name, getValue(readingSection, name, func)]
						)
					),
					readings: []
				}
			}

			output.front['mass-info'] = getMulti('mass-info', ['text', parseText]);
			output.front['latest-info'] = getMulti('latest-info', ['centered', c => c ? 1 : 0], ['lines', parseInt], ['text', parseText]);

			const readingCollapses = readingSection.querySelectorAll('.collapse[data-name="reading-collapse"]');
			readingCollapses.forEach(ele => {
				const include = getValue(ele, 'include');
				const newReading = {
					include: include === null ? true : include,
					left: !getValue(ele, 'left'),
					size: getValue(ele, 'size', parseFloat),
					margin: getValue(ele, 'margin', parseFloat),
					type: ele.dataset.type,
					alt: ele.dataset.alt == "1",
					ref: getValue(ele, 'include-ref') === false ? '' : getValue(ele, 'ref', parseText),
					title: getValue(ele, 'include-title') === false ? '' : getValue(ele, 'title', parseText),
					...(['psalm', 'acclamation'].includes(ele.dataset.type) && { sameline: getValue(ele, 'sameline') })
				};

				if (ele.dataset.type === 'psalm') {
					newReading.text = [
						getValue(ele, 'response', parseText),
						getValue(ele, 'text', parseText)
					]
				} else {
					newReading.text = getValue(ele, 'text', parseText);
				}

				output.readings.readings.push(newReading);
			});

			return output;
		}

		function loadTemplate(template) {
			const front = document.getElementById('front');
			if (template.front) {
				for (let name in buildTemplate.front) {
					if (template.front[name] !== undefined) {
						setValue(front, name, template.front[name]);
					}
				}
				setMulti('mass-info', template.front['mass-info'] || [], 'text');
				setMulti('latest-info', template.front['latest-info'].map(l => [l[0] === 1, l[1], l[2]]) || [], 'centered', 'lines', 'text');
			}
			if (template.back) {
				setMulti('notices', template.back || [], 'size', 'margins', 'text');
			}
			const readingSection = document.getElementById('readings');
			if (template.readings) {
				for (let name in buildTemplate.readings) {
					if (template.readings.options[name] !== undefined) {
						setValue(readingSection, name, ['copyright-page', 'dpa-page'].includes(name) ? template.readings.options[name] === 1 : template.readings.options[name]);
					}
				}
				let formattedReadings = structuredClone(template.readings.readings);
				formattedReadings.forEach(r => {
					if (r.type === 'psalm') {
						r.text = [r.text[0], r.text[1].split('<bv><br>').map(p => p.split('<br>'))];
					}
					else {
						r.text = r.text.split('<br>');
					}
				});
				loadReadings(formattedReadings);
			}
		}

		function loadLast() {
			wait(async function() {
				await fetch(`${SERVER_URL}/latest?key=${API_KEY}`, { method: 'GET' })
					.then(resp => resp.json())
					.then(data => loadTemplate(data))
					.catch(e => console.error('Error getting last template:', e));
			}, 'LOADING...');
			save();
		}

		function loadTemplateList(files) {
			const ltModal = document.getElementById('load-template-modal');
			const template = ltModal.querySelector('.template');
			const grid = ltModal.querySelector('.grid');

			if (!files || files.length === 0) {
				grid.innerHTML = '<p class="header">No templates found</p>';
				return;
			}

			grid.innerHTML = '';
			files.forEach(file => {
				const clone = template.cloneNode(true);
				clone.classList.remove('template');

				grid.appendChild(clone);
				clone.querySelector('p[data-name="name"]').innerText = file;
				clone.querySelector('button[data-name="load"]').onclick = async function() {
					ltModal.close();
					await wait(async function() {
						await fetch(`${SERVER_URL}/template/get/${file}?key=${API_KEY}`, { method: 'GET' })
							.then(resp => resp.json())
							.then(data => loadTemplate(data))
							.catch(e => console.error('Error getting template:', e));
					}, 'LOADING...');
					save();
				};
				clone.querySelector('button[data-name="delete"]').onclick = async function() {
					ltModal.close();
					await wait(async function() {
						await fetch(`${SERVER_URL}/template/delete/${file}?key=${API_KEY}`, { method: 'GET' })
							.catch(e => console.error('Error deleting template:', e));
					}, 'LOADING...');
					loadTemplatesModal();
				};
			});
		}
		async function loadTemplatesModal() {
			await wait(async function() {
				await fetch(`${SERVER_URL}/templates?key=${API_KEY}`, { method: 'GET' })
					.then(resp => resp.json())
					.then(data => loadTemplateList(data.files))
					.catch(e => console.error('Error getting templates:', e));
			});
			modal('load-template-modal');
		}

		function safeFilename(ele) {
			ele.value = ele.value.replace(/[^a-zA-Z0-9\-_ ]/g, '')
		}
		async function saveTemplate() {
			const stModal = document.getElementById('save-template-modal');
			const name = getValue(stModal, 'name').replace(/[^a-zA-Z0-9\-_ ]/g, '').trim();

			stModal.close();

			const data = build();
			await wait(async function() {
				await fetch(`${SERVER_URL}/template/save/${name}?key=${API_KEY}`, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					},
					body: JSON.stringify(data)
				});
			}, 'LOADING...');
		}

		const modals = document.querySelectorAll('dialog');
		Array.from(modals).forEach(modal => {
			modal.addEventListener('click', e => {
				if (e.target === modal) {
					modal.close();
				}
			});
		});
		function modal(modalId) {
			document.getElementById(modalId).showModal();
		}
	</script>
</body>
</html>